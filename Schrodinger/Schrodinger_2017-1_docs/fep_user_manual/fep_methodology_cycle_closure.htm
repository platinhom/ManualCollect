<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-US" xml:lang="en-US" data-mc-search-type="Stem" data-mc-help-system-file-name="Documentation.xml" data-mc-path-to-help-system="../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="User Manuals|FEP+ User Manual|FEP+ Methodology">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" type="text/css" data-mc-generated="True" /><title>FEP Theory</title>
        <link href="../Resources/Stylesheets/docs.css" rel="stylesheet" />
        <script src="../Resources/Scripts/custom.modernizr.js" type="text/javascript">
        </script>
        <script src="../Resources/Scripts/jquery.min.js" type="text/javascript">
        </script>
        <script src="../Resources/Scripts/require.min.js" type="text/javascript">
        </script>
        <script src="../Resources/Scripts/require.config.js" type="text/javascript">
        </script>
        <script src="../Resources/Scripts/foundation.min.js" type="text/javascript">
        </script>
        <script src="../Resources/Scripts/plugins.min.js" type="text/javascript">
        </script>
        <script src="../Resources/Scripts/MadCapAll.js" type="text/javascript">
        </script>
    </head>
    <body><a name="aanchor5630"></a>
        <MadCap:concept term="User Manuals" /><a name="aanchor5631"></a>
        <MadCap:concept term="FEP+" />
        <table class="NavLink" data-mc-conditions="Default.ScreenOnly">
            <tr class="NavLink">
                <td class="NavLeft"><span class="NavText">◀ <a href="fep_methodology_bennett.htm" class="NavLink MCXref xref xrefNavLink" xrefformat="{paratext}">Bennett Acceptance Ratio Method and Error Estimates</a></span>
                </td>
                <td class="NavCenter"><span class="NavText"><a class="NavLink MCXref xref xrefNavLink" href="fep_user_manualTOC.htm" xrefformat="{paratext}">FEP+ User Manual</a></span>
                </td>
                <td class="NavRight"><span class="NavText"><a href="fep_methodology_deltaG.htm" class="NavLink MCXref xref xrefNavLink" xrefformat="{paratext}">Conversion of ΔΔG Values to ΔG Values</a> ▶</span>
                </td>
            </tr>
        </table>
        <h1>FEP Cycle Closure Method and Error Estimates</h1>
        <p>Robust error estimates from FEP calculations are critical for the successful application of free energy calculations in prospective drug discovery projects. In FEP+, we use the cycle closure method to estimate the errors. For details about cycle closure error estimate methods, see reference <a href="fep_references.htm#CDK2_FEP" class="Ref_Number_Only MCXref xref xrefRef_Number_Only" xrefformat="{paranumonly}">6</a>. </p>
        <p>Let us start with the simplest case, a set of three ligands, L<sub>1</sub> , L<sub>2</sub> , and L<sub>3</sub>. The experimental binding free energy of ligand <i>i</i> is <i>F</i><sub class="SubItal">i</sub><sup>exp</sup>. The relative binding free energy of ligand <i>i</i> and ligand <i>j</i> is <i>F</i><sub class="SubItal">ij</sub><sup>exp</sup> = <i>F</i><sub class="SubItal">i</sub><sup>exp</sup> - <i>F</i><sub class="SubItal">j</sub><sup>exp</sup>. The free energy is a thermodynamic property, therefore for our three ligands, <i>F</i><sub>13</sub><sup>exp</sup>+ <i>F</i><sub>32</sub><sup>exp</sup>+<i>F</i><sub>21</sub><sup>exp</sup> = 0. </p>
        <p>We now perform the FEP&#160;simulations  L<sub>1</sub>→ L<sub>2</sub>,  L<sub>2</sub> → L<sub>3</sub>, and L<sub>3</sub> →  L<sub>1</sub> , and calculate the BAR free energy differences, <i>F</i><sub class="SubItal">ij</sub><sup>BAR</sup>. If the simulations are perfectly converged and the force field is perfect, we would expect <i>F</i><sub class="SubItal">ij</sub><sup>BAR</sup> = <i>F</i><sub class="SubItal">ij</sub><sup>exp</sup>and <i>F</i><sub>13</sub><sup>BAR</sup>+ <i>F</i><sub>32</sub><sup>BAR</sup>+<i>F</i><sub>21</sub><sup>BAR</sup> = 0. In practice, however, there are errors associated with the calculated free energies, so that in general, the BAR free energy differences are not equal to the experimental free energy differences, and <i>F</i><sub>13</sub><sup>BAR</sup>+ <i>F</i><sub>32</sub><sup>BAR</sup>+<i>F</i><sub>21</sub><sup>BAR</sup> = <span style="font-family: 'Symbol'">D</span> ≠ 0. We call Δ the <i>hysteresis</i> of the free energy calculation associated with this closed thermodynamic cycle.</p>
        <p>The errors in FEP calculations compared to experimental values can be separated into two categories: the systematic error coming from the difference between the force field used in the simulations and the real interactions, and the unbiased error coming from the unconverged calculation, either due to incomplete sampling of the phase space (the protein or the ligand or both are trapped in a local minimal in the conformation space) , or from the free energy estimator itself. We define <i>F</i><sub class="SubItal">ij</sub> as the theoretical free energy difference between two thermodynamic states  for the underlying force field from an infinitely long unbiased simulation and unbiased free energy estimator. If there is no systematic error in the force field, then <i>F</i><sub class="SubItal">ij</sub> =<i>F</i><sub class="SubItal">ij</sub><sup>exp</sup> . In practical FEP calculations,  the simulation is run with a finite amount of time and the sampling may have some bias, thus the calculated free energy <i>F</i><sub class="SubItal">ij</sub><sup>BAR</sup> might deviate from its theoretical value <i>F</i><sub class="SubItal">ij</sub>, and the deviation depends on the initial configuration of the simulation. Suppose we repeat the same FEP calculation an infinite number of times starting from different initial configurations and different random seeds for the velocities, then the calculated free energies have a distribution. We assume that the calculated free energies are Gaussian distributed with average <i>F</i><sub class="SubItal">ij</sub> (no systematic bias) and standard deviation σ<sub class="SubItal">ij</sub> . Then the probability density that one single FEP calculation gives a value of <i>F</i><sub class="SubItal">ij</sub><sup>BAR</sup> for this mutation is:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation47.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>For a given set of theoretical free energy differences <i>F</i><sub>13</sub>, <i>F</i><sub>32</sub>, and <i>F</i><sub>21</sub>, the overall likelihood, <i>L</i>, that the three FEP simulations give values of <i>F</i><sub>13</sub><sup>BAR</sup>, <i>F</i><sub>32</sub><sup>BAR</sup>, and <i>F</i><sub>21</sub><sup>BAR</sup> is:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation48.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>According to the maximum likelihood method, the most likely values of <i>F</i><sub>13</sub>, <i>F</i><sub>32</sub>, and <i>F</i><sub>21</sub> are the set of values that maximize the above likelihood. Taking the log of the above expression, it is clear that the set of values that maximizes the likelihood is the set of values that minimize the following function:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation49.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>Using Lagrange multipliers, it can be shown that the set of values that maximizes the likelihood is:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation50.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>and similarly for the other two mutations. It is also straightforward to prove that the above estimators have no systematic bias, and there will be no discrepancy between the free energy predictions from different paths. We can interpret the above estimators as the weighted average from the two paths. For example, the free energy difference between ligand L<sub>1</sub> and L<sub>2</sub> , <i>F</i><sub>21</sub> , can be estimated from <i>F</i><sub>21</sub><sup>BAR</sup> , or from −(<i>F</i><sub>13</sub><sup>BAR</sup>+ <i>F</i><sub>32</sub><sup>BAR</sup>), and the best estimator is a weighted average of the two predictions. The smaller the standard deviation for the mutation is, the larger the weight it has in the best estimator, and vice versa.</p>
        <p>In addition, according to the above model, the hysteresis of the cycle closure,  Δ , is also Gaussian distributed with an average of 0 and a standard deviation</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation51.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>If the sum of the three calculated free energies deviates by more than 2<i>s</i> from 0, it is almost certain (P = 0.95) that the calculations are not converged and the results are not reliable; if the sum of the three calculated free energies deviates by more than <i>s</i> from 0, it is highly probable (P = 0.68) that the calculation is not converged and the results may not be reliable. Thus the above model provides a simple way to determine whether the predictions are reliable.</p>
        <p>In practical FEP calculations, due to the high computational expense,  a given calculation is run only once, and thus one cannot estimate the standard deviation for each prediction. In this case, the rule of thumb assumption is that the standard deviation for each calculation is the same, for example 0.8 kcal/mol for each mutation. Then if the discrepancy of the free energy results from two paths is larger than 1.4 kcal/mol, it indicates the calculation is not converged and probably not reliable. Under this assumption, the best free energy estimator has the following simple expression:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation52.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>and similarly for the other two mutations. This free-energy estimate is called <span class="Keyword">ddG_cycle_closure</span>. </p>
        <p>In addition, under the assumption that the standard deviation for each calculation is the same, the hysteresis of the cycle closure itself provides an estimate of the error associated with each free energy prediction. As discussed above, the hysteresis Δ of the cycle closure is Gaussian distributed with average of 0 and standard deviation of <i>s</i> = <span style="font-family: 'Symbol'">Ö</span>3σ . So the probability that a given calculation generates a hysteresis with value Δ for the cycle closure is:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation53.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>The value of sigma that maximizes the above probability gives the maximum likelihood estimate of the standard deviation associated with each free energy calculation:</p>
        <p>
            <img src="../GeneratedImages/Equations/Equation54.svg" alt="" class="_MCEquation_0 mcReset" />
        </p>
        <p>This value is called <span class="Keyword">Error_cycle_closure</span>. Note that in the above derivation, the estimated free energies and the associated errors are the optimal estimates based on all the information gained from FEP calculations. If the underlying force field in the calculations has systematic bias, the perfectly converged FEP calculation results may still deviate from the experimentally measured values, which is something that cannot be corrected based on the above analysis. Note also that the experimental values have errors as well, and will not perfectly fulfill the cycle closure condition. </p>
        <p>The above model can be easily generalized to more complicated cases with more members in the cycle closure and several cycles sharing the same edge. </p>
        <table class="NavLink" data-mc-conditions="Default.ScreenOnly">
            <tr class="NavLink">
                <td class="NavLeft"><span class="NavText">◀ <a href="fep_methodology_bennett.htm" class="NavLink MCXref xref xrefNavLink" xrefformat="{paratext}">Bennett Acceptance Ratio Method and Error Estimates</a></span>
                </td>
                <td class="NavCenter"><span class="NavText"><a class="NavLink MCXref xref xrefNavLink" href="fep_user_manualTOC.htm" xrefformat="{paratext}">FEP+ User Manual</a></span>
                </td>
                <td class="NavRight"><span class="NavText"><a href="fep_methodology_deltaG.htm" class="NavLink MCXref xref xrefNavLink" xrefformat="{paratext}">Conversion of ΔΔG Values to ΔG Values</a> ▶</span>
                </td>
            </tr>
        </table>
    </body>
</html>