<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!--
!!    MOE 2010.10 On-Line Manuals
!!    COPYRIGHT (C) 2010
!!        CHEMICAL COMPUTING GROUP INC.  ALL RIGHTS RESERVED.
!!-->

<!--	ph4_query.htm		Pharmacophore Query Editor
!!
!!	22-oct-2010 (kk) minor edits
!!	03-sep-2009 (kg) new snapshots
!!	03-oct-2008 (kk) minor edits
!!	10-sep-2007 (ms) typos etc.
!!	11-aug-2007 (pl) created from combined ph4.htm
!!	17-dec-2002 (ms) created
!!-->

<!-- !!! (ms) search for "UPDATE:" to see further updates needed -->

<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css"
href="../manstyle.css" />


<title>The Pharmacophore Query Editor</title>

<meta panel Pharmacophore Query Editor>
<meta panel Pharmacophore: Query Rendering>
<meta panel Pharmacophore: Consensus Rendering>
<meta panel Pharmacophore: Scheme Information>

<meta fileformat .ph4>

<meta main_keywords query, scheme, consensus, feature, constraint, volume />
<meta main_keywords SMARTS, template, custom rendering, group, ungroup />
<meta main_keywords partial, essential, AtomQ, AtomL, expression syntax />
<meta main_keywords Don, Acc, Hyd, Cat, union, interior, exterior, excluded />
<meta main_keywords radius />

<meta keywords annotation, match, hit, ligand, receptor, unified />
<meta keywords dummy, meter, precedence, &, |, !, AND, OR, NOT />
<meta keywords SMILES />

</head>

<body bgcolor="#ffffff">
<a href="../index.htm"><img src="../images/logo.gif"
alt="CCG Logo" align="right" width="174" height="55" border="0" /></a>
<h4>MOE 2010.10</h4>
<h2>The Pharmacophore Query Editor</h2>
<hr noshade="noshade" />

<ul>
<li><a href="#RunningEditor">Running the Pharmacophore Query Editor</a></li>
    <ul>
    <li><a href="#Features">Features</a></li>
    <li><a href="#Constraints">Constraints</a></li>
    <li><a href="#Volumes">Volumes</a></li>
    <li><a href="#Render">Query Rendering</a></li>
    </ul>
<li><a href="#RunningConsensus">Running Pharmacophore Consensus</a></li>
<li><a href="#SeeAlso">See Also</a></li>
</ul>

<p>
The purpose of the Pharmacophore Query Editor is to manually create a query
consisting of a set of constraints on the location and type of ligand
annotations which can then be used to search and filter a conformation database.
The main characteristics of the Pharmacophore Query Editor are: 
<ul>
<li><b>Interactive Modification</b>.
The positions, radii, as well as other characteristics of the pharmacophore
query can be interactively adjusted.
</li>

<li><b>Template Ligand</b>.
A ligand (possibly in complex with a receptor) can optionally be used as a
"template" to simplify defining the features of a query.
</li>

<li><b>Template Receptor</b>.
A receptor can optionally be used to help identify key interactions
or as a template to simplify defining excluded volume constraints or
other shape constraints.
</li>

<li><b>Consensus Features</b>.
A set of aligned molecules can be used to suggest a consensus set
of pharmacophore query features.
Suggested features can be visually examined on the screen
and selectively converted into features of an edited query.
</li>

<li><b>Custom Rendering</b>.
The visual characteristics (like color) of the displayed query features and
volumes can be individually adjusted. 
The annotation points of template molecules can be customized.
</li>
</ul>

<p>
In this document we present an overview of the Pharmacophore Query Editor
and the steps required to conduct a 3D Pharmacophore Query.
In this document we will use the following terms:
</p>
<ul>
<li>A <i>ligand annotation</i>
is a set of points in space with attached labels that reflect the
presence or absence of pharmacophore features at those locations.  Each
ligand conformation in a database is annotated at search time (on the fly).
The ligand annotation is what the Pharmacophore Search procedure
&quot;sees&quot; during a search.
</li>

<li>A <i>pharmacophore annotation scheme</i>,
or more simply a <i>scheme</i>, is an automatic procedure to compute
pharmacophore annotation points (such as h-bond donor, h-bond acceptor,
hydrophobe, etc.) that make up a ligand annotation.
MOE contains a number of schemes encoding different methods of ligand
annotation.
</li>

<li>A <i>pharmacophore query</i> is a collection of restrictions imposed
on ligand annotations calculated for the atoms of a molecule.
The purpose of the query is to select a limited subset from a given set
of ligand conformations such that all restrictions of the query are satisfied.
</li>

<li>A <i>match</i> (or <i>hit</i>)
is the occurrence of a ligand conformation satisfying a query.  A match
is the successful mapping of the query features to ligand annotation
points, including the corresponding alignment of the ligand with the
query such that all restrictions of the query are satisfied.
In general, there can be many different ways in which a given query
can match a ligand.
</li>
</ul>

<p>
The Pharmacophore Query Editor is used to construct queries that are based
on a particular pharmacophore scheme (selectable in the
Pharmacophore Query Editor).  The schemes provide the definitions of
ligand annotations, for example H-bond donor, acceptor and hydrophobe.

For example,
under the <tt>Unified</tt> scheme, the aspirin molecule, below, has 13 annotation
points, <nobr>[<i>L</i>1,...,<i>L</i>13]</nobr> and one projected annotation 
point that does not pass the 
<a href="ph4_annot.htm#Exposure">Solvent Exposure Test</a> and therefore is not
annotated.
    



</p>
<p align="center"><img src="ph4_query/ex_ph4asa.png" alt="ph4 Query" /></p>

<p>
Under this scheme, <i>Aro</i> denotes an aromatic ring center,
<i>Don</i> denotes an H-bond donor,
<i>Acc</i> denotes an H-bond acceptor,
<i>Hyd</i> denotes a hydrophobic center,
<i>Aro</i> denotes an aromatic center, and
<i>Don2</i>, <i>Acc2</i>, and <i>PiN</i> denote
projected annotation points.
The Pharmacophore Query Editor can display ligand annotations on molecules
loaded into MOE.
Knowledge of the
<a href="ph4_annot.htm">Pharmacophore Annotation Schemes</a> is required
for efficient use of the Pharmacophore Query Editor.
</p>

<h2><a name="RunningEditor">Running the Pharmacophore Query Editor</a> </h2>


<br clear="both" />

<div class="floatright">
<img src="ph4_guide/ph4_query_panel.png" alt="Pharmacophore Query Panel" />
</div>

<p>The Pharmacophore Query Editor is used to create and modify pharmacophore
queries. A query consists of <i>features</i>,
<i>group constraints</i>, and <i>volumes</i>.
Queries can be saved in files and used later for searching
databases of ligand conformations using the Pharmacophore Search application.

The Pharmacophore Query Editor can be opened using one of the
following methods:

<ul>
<li>From the MOE Window, choose
<nobr><b>MOE | Compute | Pharmacophore | Query Editor</b></nobr>.
<li>From the MOE Window, choose
<nobr><b>MOE | File | New | Pharmacophore Query</b></nobr>.

<li>Using the Open panel <nobr>(<b>MOE | File | Open</b>),</nobr> select
an existing pharmacophore query file (by convention, such files have the
extension&nbsp;<tt>.ph4</tt>) and press the
<nobr><b>Open Pharmacophore Query</b></nobr> operation button.

<li>From the
<a href="ph4_search.htm">Pharmacophore Search</a> panel,
press the <b>Edit</b> button.
</ul>
<p>
A new Pharmacophore Query Editor panel will appear.
</p>

<p>
Two new chains are added to the system upon opening the Pharmacophore
Query Editor. The chains, named 'Ligand Pharmacophore Annotation' and
'Pharmacophore Query Features',  are used by the Pharmacophore application
and should be ignored by the user.
</p>

<p>If there are atoms present in the system, the editor will calculate and
display ligand annotation points using the pharmacophore scheme specified in
the panel.  The two pictures below illustrate this.  The left picture shows a
molecule without any annotation.  The right one depicts the same molecule
annotated by the Unified pharmacophore scheme as calculated and displayed by the
Pharmacophore Query Editor.
</p>

<p align="center">
<img src="ph4_query/ligand.png" alt="Ligand" /> &nbsp;
<img src="ph4_query/lig2.png" alt="Ligand annotated" />
</p>

<p>
Dummy atoms are used in the MOE Window to display ligand annotation
points, query features, and volumes.  In the Sequence Editor,
dummy residues are used for the same purpose.
Selections of the query features and volumes in the
Pharmacophore Query Editor and the corresponding dummy atoms in the MOE
Window and the dummy residues in the Sequence Editor are
synchronized:  selecting a feature or volume in the Pharmacophore
Query Editor list automatically selects all dummy atoms and dummy residues
which are associated with selected items in the query while deselecting
all others.  Similarly, selecting or deselecting a query feature or
volume in the MOE Window will select or deselect that feature or
volume in the Pharmacophore Query Editor and the Sequence
Editor.  Selection of other atoms or residues is not affected.
</p>

<p>A query consists of the following elements:

<blockquote><dl>
<dt><b>Title</b>
<dd>
Text field available for a brief description of the pharmacophore query which
will be displayed in the query section of the Pharmacophore Search.

<br clear="both" />

<div class="floatright">
<img src="ph4_guide/ph4_unified_info.png" alt="Unified Info Panel" />
</div>

<dt><b>Scheme</b>
<dd>
A pharmacophore scheme is a set of rules that define the
ligand annotation points that are to be matched by the query.

The default scheme is <tt>Unified</tt>.
See <a href="ph4_annot.htm">Pharmacophore Annotation Schemes</a> for
more information on schemes.
To see information on the currently chosen scheme, press the <b>Info</b>
button.  Depending on the scheme, a panel similar to one on the right opens.
<p>
The Information panel shows the list of annotation points supported by
the current scheme.  Each annotation type is listed along with its default
color and a brief description of the type.  The checkboxes to the left of
each annotation type determine whether the Pharmacophore Query Editor
will display the annotation type.  If on, then the annotation will be
displayed; if off, then the annotation will not be displayed.
<p>

The <b>Memory</b> text field allows the current selection of displayed
annotations to be saved.  Enable or disable the desired annotations,
then type in a name into the <b>Memory</b> field and press <b>Store</b>
to save the current enable/disable settings.  Type a name and press
<b>Load</b> or use the shortcut menu to retrieve previously saved
settings.  Press <b>Erase</b> to delete the named memory.  In this way,
subsets of any scheme can be saved, providing a means to simplify the
more complex schemes like <tt>Unified</tt>.

<p>
The <b>Show</b> buttons are a fast way of enabling <b>All</b> annotations,
restoring the <b>Default</b> collection or disabling all (with <b>None</b>). 
The <b>Query</b> button enables only those annotation features types that
are needed for the evaluation of the query feature expressions
of the current query.

<p>
<dt><b>Features, Group Constraints, Volumes</b>
<dd>
Features, constraints, and volumes are added to the current
query using the <b>Create</b> buttons in the Pharmacophore Query Editor.
Full details of their creation and modification are given in the
sections named correspondingly below.
<p>
Created features, constraints, and volumes are shown as entries in the list
area.  Three categories of list entries are separated into three distinct
portions of the list.  In each portion, the names of the entries are numbered
from 1 to <i>n</i> where <i>n</i> is the number of entries.  For convenience,
<b>Up</b> and <b>Down</b> buttons reorder the list by moving selected entries
up and down within their respective categories.  An entry can only move within
the portion of the list devoted to its category.  For example, a constraint can
be moved no further up once it has reached the top line of the constraints
portion of the list and can be moved no further down once it has reached the
bottom-most constraints line.  When an entry is moved, the names of all entries
in its category are renumbered to reflect the new ordering.
<p>
One or more list entries are deleted by selecting them in the list and
pressing the <b>Delete</b> button.
Remaining names are automatically renumbered when entries are deleted.

<p>
<dt><b>Partial Match</b>
<dd>
A partial match occurs when only a subset of the query features matches a
ligand.

<p align="center"><img src="ph4_query/partial.gif" alt="Partial Match" /></p>

<p>
When <b>Enable Partial Match</b> is turned on, the query will admit and
report partial matches.  The option menu and text field to the right of
the toggle become sensitive.  A partial match is specified by two parameters,
the type and the threshold:

<p>
<ol>
<li><i>Type of partial match</i>.
<b>At&nbsp;Least</b>: the threshold specifies the minimum number of query
features that must be matched.
<b>All&nbsp;But</b>: the threshold specifies the maximum number of query
features that may be unmatched.
<p>
<li><i>Threshold</i>.
Specifies the threshold number.  The shortcut attached to the text field
is dynamically updated to show the numbers from 1 to <i>n</i>, where
<i>n</i> is the number of features currently in the query.
</ol>

<p>
<dt><b>Comment</b>
<dd>
Notes or comments can be attached to the query file.  The <b>Comment</b>
button opens a text editor where the comment can be edited.

<p align="center"><img src="ph4_query/comment.gif" alt="Comment PH4" /></p>

</dl></blockquote>

<p>Further controls in the Pharmacophore Query Editor are as follows:

<blockquote><dl>
<dt><b>Consensus</b>
<dd>
Opens the Pharmacophore Consensus panel.  The Pharmacophore
Consensus creates a list of suggested features from a set
of aligned conformations, based on specified consensus parameters.
Suggested features can be converted to query features
and further modified. For details of the panel see
<a href="#RunningConsensus">Running the Pharmacophore Consensus</a>.
</dd>
<p>
<dt><b>Meters</b>
<dd>
Creates meters between all objects (dummy atoms) representing
query features or volumes that are selected in the list.
Any meters between query objects that are not selected
will be removed by this operation.
<b>Warning!</b> Make sure the features or volumes of interest are not
hidden or the meters will not be displayed.
</dd>
<p>
<dt><b>Remove Meters</b>
<dd>
Removes all meters associated with the query objects.
Only those meters that are
related to query items are deleted.  Other meters are not affected.
</dd>
<p>
<dt><b>Query Rendering</b>
<dd>
<img src="ph4_query/rendering.gif" align="right" alt="PH4 Rendering" />
Controls the display of the query in the MOE Window.
The <b>Change</b> button opens the Pharmacophore Query Rendering panel
    allowing for more detailed settings.  The Query Rendering option is located
    in the Pharmacophore Query Editor as well as in the Pharmacophore Query
    Rendering panel.  Changing one of these menus automatically changes the
    other.  The setting of this option menu determines which controls are
    available in the Pharmacophore Query Rendering panel.  Refer to <a
    href="#Render">Query Rendering</a>, below, for further details of the
    rendering options.
</dd>
<p>
<dt><b>Ligand Annotation</b>
<dd>
<img src="ph4_query/lig_annot.gif" align="right" alt="Ligand Annotation" />
Methods of annotating the ligand in the MOE Window.  Two option menus are
available (see figure to the right).
There are two adjustable attributes affecting the annotation: the first
determines how the annotations are rendered in the MOE Window, the second
specifies which ligand chains to annotate.

<p>The first option menu can be set to:
    <ul>
    <li><b>None</b>: Removes all rendering of the ligand annotations.
    <li><b>Point</b>: Displays ligand annotation points as small spheres.
    <li><b>Ball</b>: Displays ligand annotation points as large spheres.
    <li><b>Short</b>: Displays ligand annotation points as small spheres each with
	an associated name, for example, "L1".
    <li><b>Long</b>: Displays ligand annotation points as small spheres each with
    an associated name and pharmacophoric labels, for example,
    "L1: Don &amp; Acc".
    </ul>

    <p><b>Note:</b> Projected ligand annotation points that do not pass
    the <a href="ph4_annot.htm#Exposure">Solvent Exposure Test</a>
    are displayed as points.
</dd>

<p>The second option menu can be set to:
    <ul>
    <li><b>Visible Atoms</b>:
    Display ligand annotation of visible atoms only.

    <li><b><nobr>Unselected Chains</b></nobr>: Display ligand annotation of all
    chains that are not selected in the Sequence Editor.

    <li><b><nobr>Selected Chains</b></nobr>: Display ligand annotation of all
    chains that are selected in the Sequence Editor.
    </ul>

</dd>
<p>
<dt><b>Query Match Indicator</b>
<dd>
<img src="ph4_query/lig_match.png" align="right" alt="Ligand Match" />
Indication of the match of the edited query and the annotated chains.
The edited query is repeatedly matched against the ligands displayed and
annotated in the main window.
<ul>
    <li>
    Each annotated chain is thought to represent one ligand.
    </li><li>
    Each chain may be composed of several disconnected fragments.
    </li><li>
    The query is evaluated against each chain separately.
    </li><li>
    The set of annotated chains is controlled by the
    "Ligand Annotation:" pull-down menu.
    </li><li>
    The query evaluation includes any necessary
    translation and rotation.  The match will
    not be affected by a simple translation or
    rotation of the query or any of the ligands.
    </li>
</ul>
<p>
The match indicator displays the number of chains
that match the query.
    <ul>
    <li>
    If all chains match, the number is colored green.
    </li><li>
    If most of the chains match, the number is colored blue.
    </li><li>
    If most of the chains don't match, the number is colored purple.
    </li><li>
    If none of the chains match, the number is colored red.
    </li>
    </ul>
</dd>
<p>
<dt><b>Open</b>
<dd>
    Loads an existing query into the panel.
    If the panel is linked with a Pharmacophore Search panel, then
    the query's title is also displayed in that search panel.
</dd>
<p>
<dt><b>Search</b>
<dd>
    Opens a Pharmacophore Search panel.  When the
    Pharmacophore Search panel is opened in this manner then the two
    panels are linked together.  While both panels are open, the search will
    always use the current value of the query in the editor panel.
</dd>
<p>
<dt><b>Save</b>
<dd>
    Saves the query in a file
    to be used later in a pharmacophore search.
    By convention, MOE uses the file extension&nbsp;<tt>'.ph4'</tt> for
    pharmacophore query files.
</dd>

</dl></blockquote>

<h3><a name="Features">Features</a> </h3>

<p>
A feature is added to the current query with the <b>Feature</b> button.
The new feature is specified as a location in space, a radius, and
an expression.  The location and radius are depicted in the MOE Window as
a sphere.  If there are selected atoms, the new feature is automatically
positioned at their centroid.

If there are no atoms selected, the new feature is positioned at the center
of the MOE Window. The sphere determines a volume of space in which the
center of any "matching" ligand feature must be located.
There are two different any type features:

<ol>
<li><a name="AtomQ"><b>AtomQ</b> for any heavy atom (the default feature type).</li>
<li><a name="AtomL"><b>AtomL</b> for any lone pair or hydrogen.</li>
</ol>

To match any atom <i> AtomQ|AtomL </i>
can be used.

The any type feature <i> Any</i> in versions prior to 2009 is now <i>obsolete</i>.
If it is present in a query generated with a MOE version prior to 2009 it is treated
as <i> AtomQ</i>.

<p>
It is often desirable to design a query that would match those
database ligands that share some pharmacophoric features with
a given template ligand or ligands.  If such a ligand or
ligands are present in the system and their annotation points
are selected when a new query feature is being created, the
editor will automatically position the new feature at the
center of the selected annotation points and set the expression
associated with the new feature to a combination derived from
the labels attached to the selected annotation points.

<p>The pictures below illustrate the use of a ligand template.
The left picture shows a ligand in the MOE Window with the small spheres
indicating each of its annotation points.  Assume that the ligand annotation
point at the center of the aromatic ring is selected when the
feature is created. The right picture shows a sphere
representing the query feature that is created.  Observe that its center is
located at the center of the aromatic ring.

<p align="center">
<img src="ph4_query/lig2.png" alt="Ligand not annotated" /> &nbsp;
<img src="ph4_query/lig3.png" alt="Ligand annotated" />
</p>

<p>When a ligand template is no longer needed it can be deleted.</p>

<p>By default, feature spheres are rendered in line mode using a color
derived from the colors of the selected ligand annotation points.  For
further information on rendering options see <a href="#Render">Query
Rendering</a>.
</p>

<p>
Features of the current query are given in the list in the Pharmacophore Query
Editor.  For example, a feature created from a ligand template atom selection
that includes an H-bond donor, an H-bond acceptor, and a hydrophobe would
appear as:

<pre>
    F1     Don|Acc|Hyd
</pre>

<p>
This line says that query feature "F1" (a name is automatically assigned, where
"F" stands for feature) has feature expression <nobr>"Don|Acc|Hyd"</nobr>.
In other words, in order for a ligand conformation to match this query, it
would have to include a ligand annotation point that is positioned within the
volume of "F1" and whose attached labels include at least one of Donor, Acceptor,
or Hydrophobe.
</p>

<p><b>Note:</b> When an expression is created automatically from a selection of
annotation points of different types, it often needs to be modified by
the user to reflect the true intent of the query.  For example, the
above expression matches both hydrophilic and hydrophobic annotations and
likely needs to be modified to either to "Don|Acc" or "Don|Acc!Hyd" in order
be part of a chemically meaningful query.
</p>

<p>
To modify a query feature, first select it in the list.  The area of the panel
directly below the list displays additional information and controls related to
the selected feature or features.  For example, assuming feature "F4" with
feature expression "Don|Acc" is selected, the following might be displayed:
</p>

<p align="center"><img src="ph4_query/feature.gif" alt="Feature" /></p>

<p>The editable attributes of a feature include the feature expression,
essential attribute, color, radius, position and appearance.
Features may be set to be ignored during the search, or hidden from the display.
Note that features and volumes have several common attributes
and may be modified at the same time by selecting them in the list.
In this case, available attributes will be applied to the selected
items in which the attribute can be applied to.  For example, the
essential toggle will apply to all selected features, leaving the
volumes untouched.  The expression text is not available in this
case.
</p>

<blockquote>
<p><b>Feature Expression</b>.  The selected feature will match only those
ligand annotation points whose labels satisfy the expression appearing in the
text field to the right of the name of the feature.  The expression can be
changed by choosing from the option menu or by typing into the text field.
Note that after typing in the text field, <tt>&lt;Enter&gt;</tt> must be
pressed to have the change take effect.  Although the shortcut in the text
field only allows single item expressions, by typing in the text field you can
create complex logical expressions.
Valid expressions are described in the section
<a href="#ExpressionSyntax">Expression Syntax</a> section.

<p><b>Essential Attribute</b>.
An essential feature must always be matched, even in a partially
matched query.  To set this attribute, turn on the <b>Essential</b> toggle.

<p><b>Ignore</b>.
When ignore is set, an <b>i</b> will appear to the right of the
feature name in the list and the feature will be ignored during the search.
Ignoring a feature is functionally equivalent to deleting the item.


<p><b>Hidden</b>. When hidden is set, the feature will be hidden
from the display in the MOE Window.  An <b>h</b> will appear in the
list to the right of the feature name.  Selecting the feature in the
list will still highlight the feature in the MOE Window but once
the feature is not selected, it will no longer be visible.
To turn off the display of all the entire query (features and volumes) the
<b>Query Rendering</b> style <b>None</b> can be used.

<p><b>Color</b>.
The sphere denoting the feature in the MOE Window can be displayed in
a variety of colors.
The option menu contains predetermined colors to choose from.
If <b>Auto</b> is pressed then the color is calculated from the
feature expression.  The color can also be changed from within the
Pharmacophore Query Rendering panel.

<p><b>Radius</b>.
The radius, in angstroms, of the spherical volume of the feature specifies
both the radius of the displayed sphere and the maximum permitted distance
between the feature and a matched ligand annotation point.

<p>The radius is displayed in the text field to the right of the label
<b>R</b>.  It can be changed by typing in another value or by manipulating the
dial. Note that after typing in the text field, <tt>&lt;Enter&gt;</tt> must be
pressed to have the change take effect.

<p>If a volume has several spheres, selecting the volume line in the
list is equivalent to selecting each sphere individually.  Thus,
when a volume is selected, the radius text field
shows the <i>average of the radii</i> of the spheres within the
volume. In this case, modifying the radius by typing into the text field
or manipulating the dial alters the radius of each sphere of the selected volume
by the amount the average has been changed, thus maintaining the average
value.

<p>To set the radii of all spheres in a volume to a specific value, first
set the average to 0 and then set the value to the desired amount.

<p><b>Position</b>.  The spatial position of a query feature can be modified
directly in the MOE Window.  By selecting the feature in the list, the center
of the sphere representing the feature is selected in the MOE Window.  The
feature can then be translated in the same way as an 
<a href="../moe/gui/mouse.html#EditingAtoms">atom selection.</a>


<p><b>Appearance</b>. The rendering attributes include the position and form
of the label, and the sphere rendering style.  For more information
see the <a href="#Render">Query Rendering</a> section.

</blockquote>

<p>
<a name="ExpressionSyntax"></a>
<b>Expression Syntax</b>.
The syntax for feature expressions is as follows.
The following table describes the syntax of the expression language.
In the table,
&nbsp;<tt>::=</tt>&nbsp; means "is defined as" and
&nbsp;<tt>|</tt>&nbsp; (unquoted vertical bar) means "or".


<blockquote>
<pre>
Expression ::= Term | Term Operator Expression | '!' Expression
Term       ::= Identifier | '(' Expression ')' | "SMARTS"
Identifier ::= 'AtomQ' | 'AtomL' | 'Any' | [a label defined by the scheme]
Operator   ::= '!' | '&amp;' | '|'
</pre>
</blockquote>

<p><b>Note: </b> Of the operators <tt>'!'</tt> (<i>NOT</i>),
<tt>'&amp;'</tt> (<i>AND</i>), and <tt>'|'</tt> (<i>OR</i>),
<tt>'!'</tt> has highest precedence and
<tt>'|'</tt> has lowest.  In a tie, the
operator on the left has higher precedence.
Please see <a href="../moe/molsystems/smiles.html">SMILES Syntax</a> for
more information on SMILES and SMARTS.

<p>
During the search, the feature expressions are evaluated for each attempted
match.  If any expression evaluates to 0, the match is rejected.
To evaluate the expression for a given mapping between the query
features

<nobr>{ <i>F<sub>i</sub></i></i> | <i>i</i>=1,2... }</nobr>

and the annotation points

<nobr>{ <i>L<sub>j</sub></i></i> | <i>j</i>=1,2... },</nobr>

the following steps are applied:

<ol>
<li>
Substitute all identifiers or SMARTS patterns in the feature expression
<i>F<sub>i</sub></i>
that refer to labels attached to ligand point <i>L<sub>j</sub></i> with 1.
The identifier <tt>Any</tt> is always substituted with 1.

<li>
Substitute all identifiers or SMARTS patterns in the feature expression
<i>F<sub>i</sub></i> that refer to labels <i>not</i> attached to ligand
point <i>L<sub>j</sub></i> with 0.

<li>
Evaluate the expression as a logic expression with
the operators <tt>'|'</tt>, <tt>'&amp;'</tt> and <tt>'!'</tt> standing
for logical operations <i>OR</i>, <i>AND</i> and <i>AND-NOT</i>, respectively:

<p><center>
<table class="titlebar">

<tr>
<th width="20"><i>A</i></th>
<th width="20"><i>B</i></th>
<th width="50"><i>A</i>&nbsp;|&nbsp;<i>B</i></th>
<th width="50"><i>A</i>&nbsp;&amp;&nbsp;<i>B</i></th>
<th width="50"><i>A</i>&nbsp;!&nbsp;<i>B</i></th>
<th width="50">!<i>A</i></th>
</tr>

<tr>
<td style="text-align: center">1
<td style="text-align: center">1
<td style="text-align: center">1
<td style="text-align: center">1
<td style="text-align: center">0
<td style="text-align: center">0

<tr>
<td style="text-align: center">1
<td style="text-align: center">0
<td style="text-align: center">1
<td style="text-align: center">0
<td style="text-align: center">1
<td style="text-align: center">0

<tr>
<td style="text-align: center">0
<td style="text-align: center">1
<td style="text-align: center">1
<td style="text-align: center">0
<td style="text-align: center">0
<td style="text-align: center">1

<tr>
<td style="text-align: center">0
<td style="text-align: center">0
<td style="text-align: center">0
<td style="text-align: center">0
<td style="text-align: center">0
<td style="text-align: center">1

</table>
</center>

</ol>

<p>For example, consider an annotation point,

<i>L<sub>j</sub></i> ,

with attached labels <nobr>"Don &amp; Acc"</nobr> and a
query feature,

<i>F<sub>i</sub></i>,

with associated expression
"(Don&nbsp;|&nbsp;Hyd)&nbsp;!&nbsp;Cat".  To determine whether

<i>L<sub>j</sub></i> and
<i>F<sub>i</sub></i>

can be matched, we apply the evaluation steps above:
<ol>

<li>

Substitute label <i>Don</i> in the expression with 1.
The expression becomes

<nobr>"(1 | Hyd) ! Cat".</nobr>

<li>

Substitute labels <i>Hyd</i> and <i>Cat</i> in the expression with 0.
The expression becomes

<nobr>"(1 | 0) ! 0".</nobr>

<li>

Evaluate the logical expression

<nobr>"(1 | 0) ! 0",</nobr>

yielding result 1.
Thus, the ligand point <i>L<sub>j</sub></i> and
the query feature <i>F<sub>i</sub></i> can be matched.

</ol>

The expressions are interpreted as follows.

<p><center>
<blockquote>
<table class="titlebar" border=1 cellpadding=5>

<tr>
<th>Label</th>
<th>Interpretation</th>

<tr>
<td align="center">
<i>A</i>
<td>
Label <i>A</i> must be attached to any annotation
point that matches the feature.

<tr>
<td align="center">
!<i>A</i>
<td>
Label <i>A</i> must <i>not</i> be attached to any annotation
point that matches the feature.

<tr>
<td align="center">
Any
<td>
Any label can be attached.

<tr>
<td align="center">
<nobr><i>A</i> &amp; <i>B</i></nobr>
<td>
Both labels, label <i>A</i> <i>and</i> label <i>B</i>, must be attached.

<tr>
<td align="center">
<nobr><i>A</i> | <i>B</i></nobr>
<td>
At least one of label <i>A</i> <i>or</i> label <i>B</i> must be attached.

<tr>
<td align="center">
<nobr><i>A</i> ! <i>B</i></nobr>
<td>
Label <i>A</i> must be attached while label
<i>B</i> must <i>not</i> be attached.

</table>
</blockquote>
</center>

</blockquote>


<h3><a name="Constraints">Constraints</a></h3>

<p>
To create a new query group constraint, first select one or more query
features in the list.  Then press the
<b>Constraint</b> button to create a constraint that applies to all the
selected features.  A line is added to the list giving the
name of the constraint, its
type, and the names of the features it affects.

<p>
For example, assume that the query does not include any constraints, and that
features F2 and F3 are selected in the list when the
constraint is created.
The following line appears in the list:

<pre>
    C1    At Least One   F[2,3]
</pre>

<p>
This signifies that the name of the constraint is "C1"
(a name is automatically assigned, "C" stands for constraint),
its constraint type is
"At Least One", and it operates on features F2 and F3.
This specifies that at least one of query features
F2 and F3 must match ligand points in a conformation in order for
there to be an overall match between that conformation and the query.

<p>
To modify a query constraint, first select it in the list.  The area of the
panel directly below the list displays additional information and controls
related to the selected constraint.  For example, if constraint "C1" is
selected in the list, the following might be displayed:

<p align="center"><img src="ph4_query/constraint.gif" alt="Constraint" /></p>

<p>The editable attributes of a constraint are the constraint type
and the features included in the constraint.  Multiple constraints
may not be edited at the same time.
Constraints can be ignored from the query.

<blockquote>
<p><b>Constraint Type</b>.  This option menu determines the type of the
constraint, given as a rule that is applied to the query features included in
the constraint.

<ul>
<li><b>At Least One</b> - <b>At Least Five</b>.

Specifies that at least one, two, three, four or five of the constrained query
features must match a ligand annotation.  At least one is the default.

<li><b>Exactly One</b> - <b>Exactly Two</b>.
Specifies that exactly one or two of the constrained query
features must match.

<li><b>All or None</b>. Specifies that either none of the constrained
query features must match or all of them must match.

<li><b>Same Atoms(s)</b>.  Specifies that the atoms in a molecule
that were used to derive the annotations must be the same.  For example,
a heavy atom hydrogen bond donor and its associated projected
annotation.  This constraint is used to enforce that upon match of both,
the underlying defining atoms must be the same.

<li><b>Share an Atom(s)</b>.  Specifies that the atoms in a molecule
that were used to derive the annotations must have an atom in common.
For example, the centroids of two fused aromatic rings have the ring
junction atoms in common.

</ul>

<p><b>Ignore</b>.
When ignore is set, an <b>i</b> will appear to the right of the
constraint name in the list and the constraint will be ignored during the
search.  Ignoring a constraint is functionally equivalent to deleting the
item.

<p><b>Constrain Selected Features</b>.
This button is used to redefine the set of query features included in
the constraint.  To do so, select the constraint and the features to
be included in the constraint.  Then push this button to
constrain the selected features.

<p><b>Select Constrained Features</b>.
Pushing this button is a convenient way to select, in the list,
all the query features included in the constraint.


</blockquote>

<h3> <a name="Volumes">Volumes</a> </h3>

<p>A volume is a spatial constraint imposed on selected atoms of the
ligand molecule.  The position and shape of the volume is defined by
a single sphere or the union of several spheres.  The function of the
volume is determined by the volume expression and the volume type.
The volume expression determines which atoms of the ligand molecules
are involved in the constraint.  The volume type determines and how they
are constrained by the volume.

<h4> <a name="CreatingVolumes">Creating Volumes</a> </h4>

<p>Volumes can be created as individual spheres and then
grouped together or they can be created immediately as a union of
spheres.
Volumes are created with the <b>Volume</b>, <b>Union</b>, <b>Group</b>
and <b>Ungroup</b> buttons.

The <b>Volume</b> and <b>Union</b> buttons are located above the list,
the <b>Group</b> and <b>Ungroup</b> buttons are located to the right
of the list.

<blockquote>
<dl>
<dt><b>Volume</b>
<dd>
A new volume is created as a single sphere of a default radius.
The new sphere is positioned at the centroid of the
selected atoms.

If no atoms are selected, the sphere is positioned
at the center of the MOE Window.

<p><dt><b>Union</b>
<dd>
A new volume is created as a union of several new spheres, one sphere
for each atom selected.

The spheres comprising the new volume are positioned at the centers
of the selected atoms
and acquire the van der Waals radii of the selected atoms.

If only one atom is selected, the new volume is a single sphere.
If there are no atoms selected, this button is not available.

<p><dt><b>Group</b>
<dd>
A new volume is created as a union of the selected spheres.
(The selected spheres have already been created and previously used in
other existing volumes.)  The <b>Group</b> button extracts
the spheres from their respective volumes and moves them
into the newly created volume.  Volumes that become empty after
this operation are automatically deleted.

The volume properties of the new volume, such as the expression,
type, or color, are copied from the volume of the first selected sphere.

The spheres can be selected either explicitly,
by highlighting lines of individual spheres,
or implicitly, by highlighting lines of entire volumes.

If there are less than two spheres selected,
this button is not available.

<p><dt><b>Ungroup</b>
<dd>
A new volume is created for each of the selected spheres.
(The selected spheres have already been created and previously
used in other existing volumes.)  The <b>Ungroup</b> button extracts
the spheres from their respective volumes and, for each sphere,
creates a new volume comprised of only that sphere.
Volumes that become empty after
this operation are automatically deleted.

The volume properties of each new volume, such as the expression,
type,  or color, are copied from the volume that contained
the selected sphere before the operation.

The spheres can be selected either explicitly,
by highlighting lines of individual spheres,
or implicitly, by highlighting lines of entire volumes.

If there are no spheres selected or if none of the selected spheres
belong to a multiple-sphere volume, this button is not available.
</dl>
</blockquote>

<p>The new volume is added to
the list and is given the name "V" followed by a number, e.g.
"V1".  If there are several spheres in the volume then a <b>+</b> sign
is shown to the left of the volume indicating the volume can be
<i>opened</i> to access the individual spheres.  For example, if there are no
current volumes, 3 atoms are selected and the <b>Union</b> button is pressed
then the following line appears in the list:

<pre>
    +V1 Excl
</pre>

<p>Double-clicking on the volume line in the list will open the
volume to display:

<pre>
    V1 Excl
    :	Sphere 1
    :	Sphere 2
    :	Sphere 3
</pre>

<p>Double-click on an open volume line to close the list and put
back the <b><tt>+</tt></b> sign to indicate this volume contains
multiple spheres.

<h4> <a name="VolumeType">Volume Type</a> </h4>

<p>
<p>A volume can be one of three types: excluded, included or exterior.
The type of the volume specifies the constraint imposed on
the region of space specified by the volume spheres and
the atoms specified by the volume expression.

<blockquote>
<p>An <i>excluded volume</i> constraint is satisfied if no atom matching
the volume expression is located within the volume.

<p>An <i>included volume</i> constraint is satisfied if at least one atom
matching the volume expression is located within the
volume.

<p>An <i>exterior volume</i> constraint is satisfied if no atom matching
the volume expression is located exterior to the volume.

</blockquote>


<p>The default volume type is the excluded volume.

<h4><a name="VolumeExpression">Volume Expression</a></h4>

<p>
The volume expression is a SMARTS string that specifies which ligand atoms are
to be constrained by the volume.  Only those ligand atoms that match (any part
of) the SMARTS string will be considered for the volume constraint.  An empty
string specifies the set of all heavy atoms.

<p><b>Note:</b>  The empty string and the "[#Q]" string are equivalent.
Both these expressions will be processed faster than other SMARTS expressions.

<p>For example, the SMARTS string <nobr>"C(=O)[O-]"</nobr> specifies all
atoms (the carbon and the oxygens) of the carboxylate group.  String
<nobr>"[C$(C(=O)[O-])]"</nobr> specifies only the carboxylate carbon.
String <nobr>"[OX1]=C-[OX1]"</nobr> is an alternative, more robust
definition of the carboxylate group.

<h4><a name="ModifyingVolumes">Modifying Volumes</a></h4>

<p>To modify a volume, first select it in the list.  The area of the panel
directly below the list displays additional information and controls
related to the selected volume or volumes.  For example, assuming volume
"V3" is selected in the list, the following might be displayed:

<p align="center"><img src="ph4_query/volume.gif" alt="Volume" /></p>

<p>The editable attributes of a volume include the expression, type,
color, radius, position and appearance.  Volumes may be ignored from the
query or hidden from the display.  Multiple volumes may be modified at the
same time by selecting more than one in the list.

<p>Note that volumes and features have several common attributes
and may be modified at the same time by selecting them in the list.
In this case, available attributes will be applied to the selected
items in which the attribute can be applied to.  For example, the
essential toggle will apply to all selected features, leaving the
volumes untouched.  The expression text is not available in this
case.

<blockquote>

<p><b>Expression</b>.  An expression can be associated with a volume via a
SMARTS string.  A volume will involve only those ligand atoms that match the
associated SMARTS expression.  For example, expression "C(=O)[O-]" will involve
only carboxylate atoms.


<p><b>Volume Type</b>.
The volume type is modified using the option menu labeled <b>V:</b>.
The type can be one of <b>Excluded</b>, <b>Included</b>, or <b>Exterior</b>.
The chosen type will specify the relationship between the volume
and the atoms matched with the associated SMARTS
expression. An excluded volume must be completely void
of any such atoms in its interior, an exterior volume must be completely
void of any such atoms in its exterior.  and an included volume must
include at least one such atom.

<p><b>Ignore</b>.
When ignore is set, an <b>i</b> will appear to the right of the
volume name in the list and the volume will be ignored during the search.
Ignoring a volume is functionally equivalent to deleting the item.

<p><b>Hidden</b>. When hidden is set, the volume will be hidden
from the display in the MOE Window.  An <b>h</b> will appear in the
list to the right of the volume name.  Selecting the volume in the
list will still highlight the volume in the MOE Window but once
the volume is not selected, it will no longer be visible.


<p>Individual spheres within a volume can be neither hidden nor ignored.
The attribute always applies to the entire volume.

<p>To turn off the display of all the entire query (features and volumes) the
<b>Query Rendering</b> style <b>None</b> can be used.


<p><b>Color</b>.
This is the color of the sphere denoting the volume in the
MOE Window.  It can be changed by choosing another color from the
option menu or by using the <b>Auto</b> button.

<p><b>Radius</b>.
The radius, in angstroms, of the spherical volume of the volume specifies
both the radius of the displayed sphere and the maximum permitted distance
between the volume and a matched ligand annotation point.

<p>The radius is displayed in the text field to the right of the label
<b>R</b>.  It can be changed by typing in another value or by manipulating
the dial. Note that after typing in the text field, <tt>&lt;Enter&gt;</tt>
must be pressed to have the change take effect.

<p>When multiple volumes are selected then the radius text field
shows the <i>average of the radii</i> of the selected volumes.  In
this case, modifying the radius by typing into the text field or
manipulating the dial alters each selected volumes' radius by the
amount the average has been changed, thus maintaining the average value.

<p>To set the radii of all selected volumes to a specific value, first
set the average to 0 and then set the value to the desired amount.

<p>The number to the right of the dial
is the distance in angstroms between the boundary of the
selected volume and atoms matched by the volume's SMARTS expression.  Only
atoms of annotated ligands are considered.  A positive value indicates
that there is no overlap for an excluded volume or there is an overlap for
an included volume.  Negative values are displayed in red and indicate
that there is a conflict and that the query would not match the annotated
atoms.

<p><b>Position</b>.  The spatial position of a volume can be modified directly
in the MOE Window.  By selecting the volume in the Pharmacophore Query Editor
list, the centers of the spheres representing the volume are selected in the
MOE Window.  The volume can then be translated in the same way as an 
<a href="../moe/gui/mouse.html#EditingAtoms">atom selection.</a>

<p>Individual spheres in a volume can also be repositioned by
selecting just the single sphere in the list and moving it in the
MOE Window.

<p><b>Appearance</b>. The rendering attributes include the position and form
of the label, and the sphere rendering style.  For more information
see the <a href="#Render">Query Rendering</a> section below.

</blockquote>

<h3> <a name="Render">Query Rendering</a> </h3>

<p>The query may be rendered in a variety of different styles in the MOE
Window.  Simple changes may be made from within the Pharmacophore Query
Editor with the Query Rendering option menu.

<p align="center"><img src="ph4_query/rendering.gif" alt="Rendering" /></p>

<p>For an extensive choice of rendering styles, the Pharmacophore Query
Rendering panel can be used.  The <b>Change</b> button opens the panel:

<p align="center"><img src="ph4_query/lig_qrender.gif" alt="Query Render" /></p>

<p>The Query Rendering option menu at the top of the panel is identical to the
Query Rendering menu found in the Pharmacophore Query Editor.  Changing the
value in either panel will change both option menus.

<p>The panel controls are as follows:

<blockquote>
<p>

<b>Query Rendering</b>.  This is a duplicate of the option menu displayed in
the Pharmacophore Query Editor.  It determines how the query is rendered in the
MOE Window as well as which rendering controls are available in the
Pharmacophore Query Rendering panel.  It can be set to one of the following:

<blockquote>
<table>
<tr>
<td valign="top">Custom
<td valign="top">
Provides the user with full control over how the query is rendered.
All controls are available,
enabling color, text, and the appearance of features and
volumes to be specified.

<tr>
<td valign="top">Spheres
<td>Query features and volumes are rendered as spheres consisting of
lines. For each feature, its name and labels are displayed.   The name of
each volume is displayed.  The
panel displays controls that can be used to change colors of features or
volumes.


<tr>
<td valign="top">Contours
<td valign="top">
Displays centers of features and fully annotated dotted contours of
features and volumes.


<tr>
<td valign="top">Centers
<td valign="top">
Displays small solid spheres at the centers of query features and the
spheres of the volumes.  No spheres are displayed to represent the radius
of each query feature or volume.  The names of the query features and
volumes are also displayed, but no labels.  The panel displays controls
that can be used to change colors of features or volumes.

<tr>
<td valign="top">None
<td valign="top">
Displays small solid spheres at ligand annotation points with no names or
labels of query features.  Nothing is displayed to denote volumes.
No rendering controls are available when this option is chosen.

</table>
</blockquote>

<p><b>Colorize Text</b>.
When colorized, the annotation text in the MOE Window and
the Sequence Editor is drawn in the color of the annotated object.
Otherwise, the text is drawn in the default color.  Note that in
the Sequence Editor, the color used to display the name will not be visible
if the item is selected.

<p><b>Apply to Selected Items</b>.

Specifies which <i>group</i> of objects will be affected
by the <b>Sphere</b>, <b>Density</b>, <b>Text</b>, and <b>Color</b>
buttons below.  If turned on then the selected features and the selected
volumes will be modified. Otherwise, all features and all volumes will be
affected.

<p><b>Sphere</b>, <b>Density</b>, <b>Text</b>, <b>Color</b>.
These button arrays
indicate current settings found in the specified rendering
group.  The sphere, density and text buttons are drawn in blue if at least one
of the group objects has that setting.  Similarly, the color buttons
show a small rectangle if any group object is
currently displayed in that color.

<dir>
<table>
<tr>
<td valign="top">Sphere
<td valign="top">Controls the rendering mode of the displayed spheres.  The
spheres can be displayed in either contour, dot, line or solid modes.  The
density attribute will determine the look of the dots, lines and solids.

<tr>
<td valign="top">Density
<td valign="top">Specifies rendering density of the displayed spheres, with
the values from <b>Min</b> to <b>Max</b> providing a wide range of
drawing capabilities.

<p><span class="tip">Tip!</span>
In order to see a change in the <b>Min</b> and <b>Low</b> densities,
the radius of your sphere needs to be greater than 2.5.</p>

If you have the scaled density
on and your radius is <= 2.4, you will see no difference between
<b>Min</b> and <b>Low</b> densities.  This is
because for small radii low dips to min, while min can't go any lower,
so it stays where it is.  (Similarly <b>High</b> and <b>Max</b>
will not change for spheres with large radii.)
<p>
<tr>
<td valign="top">Text
<td valign="top">Controls the rendering mode of the displayed labels. For
example, if <b>Centered</b> is chosen, the position labels appear at the
centers of the spheres.

<tr>
<td valign="top">Color
<td valign="top">Changes the color of the spheres and, if <b>Colorized Text</b>
is selected, the color of the annotation text.
If <b>Auto</b> is pressed, colors are calculated from the type
expressions.

<p>A small rectangle drawn in the center of a color button,
indicates that at least one feature or volume of
the intended set (selected or not selected)
is currently displayed in that color.
</table>
</dir>

</blockquote>


<h2><a name="RunningConsensus">Running Pharmacophore Consensus</a> </h2>

<p>The Pharmacophore Consensus is used to generate suggested features for a
pharmacophore query which can then be converted to query features. To
open the Pharmacophore Consensus panel press the <b>Consensus</b> button
in the Pharmacophore Query Editor.

<p>The following panel will appear:

<p align="center"><img src="ph4_query/consensus.png" alt="consensus" /></p>

<p>A consensus calculation requires a set of input molecules, a tolerance
radius, the consensus score threshold and the consensus score mode.  When
all of the input parameters have been specified, the <b>Calculate</b>
button begins the search.  A summary of the preprocessing step is written
to the CLI and the list of <i>suggested features</i> is displayed in the
panel.

<p><span class="tip">Tip!</span>
The input to the consensus calculation must be a set of
<i>aligned</i> conformations.
</p>

<h3> <a name="ConsensusInput">Consensus Input Molecules</a> </h3>

The conformations used in the consensus calculation can be drawn both from
the set of molecules loaded in MOE and from a specified database.  The
<b>Input</b> toggle boxes and the controls below the toggles specify from where
the input molecules are obtained.

<p align="center">
<img src="ph4_query/consensus_top.png" alt="Top of Consensus Panel" /></p>

<ul>
<p><li><b>MOE</b>
<p>If the <b>MOE</b> toggle is turned on then the
molecules currently loaded in MOE will be included in the set of
input molecules. The set of
<!-- INACTIVES DISABLED
active and inactive
-->
conformations in MOE
Window is specified using visibility of atoms and the selection state of the
molecule chains.

<p>The controls related to the MOE molecules are as follows:

<blockquote>

    <p><b>MOE:</b> Specifies the set of loaded molecules that will be
    used as the input to the consensus calculation.

<!-- INACTIVES DISABLED
    <p><b>Active</b>. Specifies the set of molecules
    considered active.  The consensus is calculated only on annotation
    points of active molecules.  Annotation points of active molecules
    that are near annotation points of inactive molecules are eliminated.

    <p><b>Inactive</b>.  Specifies the set of inactive molecules.
    If a molecule is present in both the active set
    and the inactive set, it is considered inactive.
-->

</blockquote>

<p><li><b>Database</b>
<p>
<p>If the <b>Database</b> toggle is turned on then molecules
stored in the specified database will be included in the set of
input molecules.


<p>The controls related to the database are as follows:

<blockquote>

<p><b>Database</b>. The name of the input database file.  The
field can be changed by pressing the <b>Browse</b> button to the right
of the field.  The <b>Open</b> button opens the specified database
in a Database Viewer.

<p><b>Selected Entries Only</b>.
Use only entries selected in the Database Viewer for the calculation.
If the Database Viewer is not open, the value of the toggle
is ignored and the calculation uses all entries.

<p><b>Molecule</b>.
The name of the molecule field to use in the calculations.

<p><b>Sequence</b>.
The name of the molecule sequence field to use in the calculations.
Conformations of the same molecule share the same molecule sequence number.
If the value is set to '(none)', the molecule sequence will be calculated
from molecules in the Molecule field.

<!-- INACTIVES DISABLED
<p><b>Activity</b>, <b>Threshold</b>.

The set of active and inactive conformations in the database is specified using
an <i>activity field</i>, together with a given <i>activity threshold</i>.
Database entries with an activity value above the activity threshold are
considered active, while entries smaller than or equal to the threshold value
are considered inactive.
-->

<!--
<p><b>Use Annotation Field</b>.
Use the ligand annotation field.  The field contains
precomputed ligand annotations.  If the ligand annotation
field is not used, ligand annotations will be calculated
from molecules in the Molecule field.

The name of the ligand annotation field is displayed
to the right of the toggle.
Black text color indicates that the field is present
in the database.
Gray text color indicates that the field
is not present in the database.
-->

</blockquote>

</ul>

<h3> <a name="ConsensusParameters">Consensus Parameters</a> </h3>

<p>The consensus parameters consist of the three controls located in
the middle part of the Pharmacophore Consensus panel:

<p align="center">
<img src="ph4_query/consensus_mid.png" alt="Mid Consensus Panel"/></p>

<blockquote>

<p><b>Tolerance</b>.
The neighborhood distance threshold.  Annotation points
closer than this distance are considered to be neighbors.
Neighborhoods determine in which regions of space the
consensus score will be calculated.

<p><b>Threshold</b>.
The consensus score threshold.  The score measures the level of
consensus among all input molecule conformations in a region of
space.  The regions are defined by neighborhoods of annotation
points, determined by the "Tolerance" distance threshold.  A group
of annotation points will become a suggested feature only if:
1) It is composed of overlapping neighborhoods of annotation
points,  2) The consensus score of each neighborhood exceeds
the consensus score threshold, and 3) The consensus score of
the entire group exceeds the consensus score threshold.  The
consensus score of the groups of points defining each suggested
feature is displayed in the "Score" column of the list below.

<p><b>Consensus Score</b>.
The method of calculating the consensus score.
The score is a measure of the proportion of molecule
conformations represented in a set of annotation points.
There are three methods available.
"First Conformation Per Molecule" counts the number
of distinct molecules.  "Unweighted Conformations"
counts the number of distinct conformations.
"Weighted Conformations" accumulates the weighted
sum of distinct conformations.  The weights are the
inverse of the number of conformations per molecule.

</blockquote>

<p>Note that modifying the parameter settings does not automatically
update the list of suggested features.
<b>Calculate</b> must be pressed to update the list.
The consensus finds common features among a set of aligned ligand
conformations.

<blockquote>
<b>Function ConsensusScore</b>.
The algorithm for finding the consensus uses the notion of a
<i>consensus score</i>.  The consensus score is a function applied to a
set of annotation points.  Each annotation point belongs to a given
conformation of a given molecule.  The function measures the proportion
of molecule conformations represented in the set of annotation points.
There are three methods for calculating the consensus score:
<ul>
    <p><li>
    <b>First Conformation Per Molecule</b>.
	Return the number of distinct molecules
	represented in the set of points.
    </li></p>
    <p><li>
    <b>Unweighted Conformations</b>.
	Return the number of distinct conformations
	represented in the set of points.
    </li></p>
    <p><li>
    <b>Weighted Conformations</b>.
	Return the weighted sum of distinct conformations
	represented in the set of points.  The weight of
	each conformation is the inverse of the number of
	all conformations in the molecule.
    </li></p>
</ul>
</blockquote>

<p>
<blockquote>
<b>Algorithm PharmacophoreConsensus</b>.
Input: A set of molecular conformations, either from the MOE Window
and/or from a database.  The parameters are
a tolerance <i>T</i>: the maximum distance between points that are
considered to be neighbors
and, <i>C</i>, a minimum consensus score required to retain a group of points.
The output is a set of suggested features, each with a position, radius and
a type expression.  For each conformation:
<ol>
<li>Calculate (or read precomputed) annotation points.</li>
<p>
<li>For each annotation point:
<ul>
    <li> Find all neighbors: annotation points that are within distance
    <i>T</i> from that point.
    </li>
    <li>
    Calculate the consensus score for the set consisting of the point
    and its neighbors.
    </li>
    <li>
    Eliminate points with the consensus score below
    the threshold value <i>C</i>.
    </li>
</li>
</ul>
</p>

<p>
<li>
Define a graph with the remaining points as its vertices.
The edges of the graph connect points that are within distance <i>C</i> from
each other.
<ul>
    <li>
    Find the connected components (single-linkage clusters) of the graph.
    </li>
    <li>
    Calculate the consensus score for each component.
    </li>
    <li>
    Eliminate components with the consensus score below the threshold value
    <i>C</i>.
    </li>
</li>
</ul>
</p>
<p>
<li>
For each remaining component, generate one suggested feature.
(The consensus score of the component will become the consensus score
of the suggested feature.)
For each suggested feature:
<ul>
    <li>
    Set the feature position at the centroid of the component, calculated
    with equal weight on all points of the component.
    </li>
    <li>
    Set the feature radius to the distance from the centroid to the farthest
    point of the component,
    with an addition of a "buffer" distance of 0.5 angstroms.
    </li>
    <li>
    Set the feature expression
	(<a href="#SuggestedFeatureExpression">algorithm</a> described
    below).
    </li>
</li>
</ul>
</p>
<p>
<li>
Sort the features by their consensus score.
Features of equal scores are sorted by secondary keys, in this order:
radius, number of molecules, number of conformations,
length of the expression, alphabetical sequence.
</li>
</ol>

<p><b>Note:</b>
The consensus score threshold, <i>C</i>, is used in the algorithm
<i>twice</i>:
first to eliminate individual annotation points, second
to eliminate components (clusters) of annotation points.
Therefore, increasing the value of <i>C</i> to a given value, <i>x</i>,
may eliminate even those suggested features
whose current consensus score falls above the value <i>x</i>.
</blockquote>

<p>
The algorithm that is used to derive an expression
for a suggested feature is as follows:

<blockquote>
<a name="SuggestedFeatureExpression"></a>
<b>Algorithm SuggestedFeatureExpression</b>
Each suggested feature is derived from a set of nearby annotation
points; each point comes with attached labels describing
the pharmacophoric features of that point.
The feature expression associated with the suggested feature
summarizes all labels attached to the annotation
points that define the suggested feature.
The input is a set of annotation points with attached labels.
The output is the expression associated with the suggested query feature
defined by the input annotation points.
<p>
<ol>
<li>Find labels,
<i>L</i><sub>0,1</sub>,
<i>L</i><sub>0,2</sub>,
...
<i>L</i><sub>0,<i>N</i><sub>0</sub></sub>,
that are attached (common) to <i>all</i> points in the set.
Remove those labels from further consideration.

Concatenate all labels found using the <i>AND</i>
operator (<tt>&amp;</tt>) as a separator:
    <p><center><nobr>
    <i>A</i> =
    <i>L</i><sub>0,1</sub>
    &amp;
    <i>L</i><sub>0,2</sub>
    &amp;
    ...
    <i>L</i><sub>0,<i>N</i><sub>0</sub></sub>
    </nobr></center></p>

<p>
<li>
Iterate for <i>j</i>=1,2...:
<ul>
    <li>
    If the set of remaining labels is empty, go to step 3.
    </li>
    <li>
    Among the remaining labels, find the label,

	<i>L</i><sub><i>j</i></sub><sub>,1</sub>,

    attached to most points in the set.
    </li>
    <li>
    Find the labels,

	<i>L</i><sub><i>j</i></sub><sub>,2</sub>,
	<i>L</i><sub><i>j</i></sub><sub>,3</sub>,
	...
	<i>L</i><sub><i>j,N<sub>j</sub></i></sub>,

    that are attached to the same points as the label

	<i>L</i><sub><i>j</i></sub><sub>,1</sub>.
    </li>
    <li>
    Concatenate all labels found using the <i>AND</i>
    operator (<tt>&amp;</tt>) as a separator:

	<p><center><nobr>
	<i>B<sub>j</sub></i> =
	<i>L</i><sub><i>j</i></sub><sub>,1</sub>
	&amp;
	<i>L</i><sub><i>j</i></sub><sub>,2</sub>
	&amp;
	...
	<i>L</i><sub><i>j,N<sub>j</sub></i></sub>
	</nobr></center></p>
    </li>
    <li>
    Remove the labels found from further consideration.
    </li>
</ul>
<p>
<li>
Concatenate all expressions
<i>B<sub>j</sub></i> (<i>j</i>=1,2...<i>K</i>)
created in Step 2 using the <i>OR</i>
operator (<tt>|</tt>) as a separator:

    <p><center><nobr>
    <i>B</i> =
    <i>B</i><sub>1</sub>
    |
    <i>B</i><sub>2</sub>
    |
    ...
    <i>B<sub>K</sub></i>
    </nobr></center></p>

<p>
<li>
Combine expressions <i>A</i> and <i>B</i> created in Step 1 and Step 2:
<ul>
    <li>
    If <i>A</i> is empty, return
	<nobr>
	<b>Expression</b> = <i>B</i>.
	</nobr>
    </li>
    <li>
    If <i>B</i> is empty, return
	<nobr>
	<b>Expression</b> = <i>A</i>.
	</nobr>
    </li>
    <li>
    If neither <i>A</i> nor <i>B</i> is empty,
    concatenate <i>A</i> and <i>B</i>
    using the <i>AND</i> operator (<tt>&amp;</tt>) as a separator:
	<p><center><nobr>
	<b>Expression</b> = <i>A</i> &amp; (<i>B</i>)
	</nobr></center></p>
    </li>
</ul>
</ol>
</blockquote>


<h3> <a name="ConsensusOutput">Consensus Output</a> </h3>

<p>Once the consensus calculation is complete,
the list of suggested features is displayed in the panel.

<!-- !!! UPDATE: change this example from PCH to Unified -->
<p align="center"><img src="ph4_query/consensus_bot.gif"></p>

<p>Each suggested feature is given a name <b>G<i>n</i></b> used to
identify the feature in the MOE Window.  Selecting a feature will
display that feature in the MOE Window, where they can be
compared with the features already present in the query.

<p>A suggested feature that is desirable for the query can be added to the
query by selecting it in the Pharmacophore Consensus Suggested Features
list and then pressing the <nobr><b>Load Selected</b></nobr> button.  All
selected features will be added to the query.

<h2><a name="SeeAlso"></a>See Also</h2>
<p>
<a href="ph4_guide.htm">Introduction to Pharmacophores in MOE</a>
<br /><a href="ph4_annot.htm">Pharmacophore Annotation Schemes</a>
<br /><a href="ph4_elu.htm">Pharmacophore Query Elucidator</a>
<br /><a href="ph4_search.htm">Pharmacophore Search</a>
<br /><a href="confgui.htm">High Throughput Conformation Generation</a>
<br /><a href="../mdb/db.htm">MOE Molecular Database</a>
<br /><a href="../moe/molsystems/smiles.html">SMILES Syntax</a>

<p><a href="../index.htm">MOE Table of Contents</a></p>
<hr noshade="noshade" />
<a href="http://www.chemcomp.com"><img src="../images/flogo.gif"
alt="CCG Logo"
align="left" width="30" height="30" border="1" hspace="5" vspace="3" /></a>
<font size="2">
<a href="../legal.html">Copyright</a> &copy; 1997-2010
<a href="http://www.chemcomp.com">Chemical Computing Group Inc.</a><br />
<a href="mailto:info@chemcomp.com"><i>info@chemcomp.com</i></a>
</font>
</body>
</html>
